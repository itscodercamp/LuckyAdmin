{% extends "layout.html" %}

{% block title %}Dashboard Overview{% endblock %}

{% block content %}


<div class="stats-grid">
    <a href="{{ url_for('admin_routes.users_list') }}" class="card stat-card clickable-card">
        <div class="stat-icon" style="background: #e0e7ff; color: #4338ca;">
            <i class="ph ph-users"></i>
        </div>
        <div class="stat-details">
            <h3>Total Customers</h3>
            <div class="value">{{ user_count }}</div>
        </div>
    </a>
    <a href="{{ url_for('admin_routes.qr_management') }}" class="card stat-card clickable-card">
        <div class="stat-icon" style="background: #fef3c7; color: #d97706;">
            <i class="ph ph-qr-code"></i>
        </div>
        <div class="stat-details">
            <h3>QR Batches</h3>
            <div class="value">{{ batch_count }}</div>
        </div>
    </a>
    <a href="{{ url_for('admin_routes.redemptions_list') }}" class="card stat-card clickable-card">
        <div class="stat-icon" style="background: #dcfce7; color: #16a34a;">
            <i class="ph ph-gift"></i>
        </div>
        <div class="stat-details">
            <h3>Pending Redemptions</h3>
            <div class="value">{{ pending_redemptions }}</div>
        </div>
    </a>
    <a href="{{ url_for('admin_routes.goodies_admin') }}" class="card stat-card clickable-card">
        <div class="stat-icon" style="background: #fce7f3; color: #db2777;">
            <i class="ph ph-gift-box"></i>
        </div>
        <div class="stat-details">
            <h3>Active Guddies</h3>
            <div class="value">{{ reward_count }}</div>
        </div>
    </a>
    <a href="#" class="card stat-card clickable-card">
        <div class="stat-icon" style="background: #ffedd5; color: #ea580c;">
            <i class="ph ph-shopping-cart"></i>
        </div>
        <div class="stat-details">
            <h3>Pending Orders</h3>
            <div class="value">{{ pending_orders }}</div>
        </div>
    </a>
    <a href="#" class="card stat-card clickable-card">
        <div class="stat-icon" style="background: #f3f4f6; color: #374151;">
            <i class="ph ph-chat-centered-text"></i>
        </div>
        <div class="stat-details">
            <h3>New Messages</h3>
            <div class="value">{{ unread_messages }}</div>
        </div>
    </a>
</div>

<div class="dashboard-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.125rem; font-weight: 600; margin: 0;">Market Coverage</h2>
            <div style="font-size: 0.75rem; color: var(--text-muted);">Live Overview</div>
        </div>
        <div
            style="height: 200px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-radius: 12px; color: var(--text-muted); border: 1px dashed var(--border);">
            <div style="text-align: center;">
                <i class="ph ph-chart-line-up" style="font-size: 2rem; opacity: 0.5;"></i>
                <p style="margin-top: 0.5rem;">Activity Analytics Coming Soon</p>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">Admin Quick Access</h2>
        <div style="display: grid; gap: 0.75rem;">
            <a href="{{ url_for('admin_routes.qr_management') }}" class="btn btn-primary"
                style="justify-content: flex-start;">
                <i class="ph ph-plus-circle"></i> Create New QR Batch
            </a>
            <a href="{{ url_for('admin_routes.goodies_admin') }}" class="btn btn-ghost"
                style="justify-content: flex-start; border: 1px solid var(--border);">
                <i class="ph ph-gift"></i> Manage Guddies
            </a>
            <a href="{{ url_for('admin_routes.redemptions_list') }}" class="btn btn-ghost"
                style="justify-content: flex-start; border: 1px solid var(--border);">
                <i class="ph ph-list-checks"></i> Review Redemptions
            </a>
        </div>
    </div>
</div>

<!-- Recent Transactions List Section -->
<div class="recent-activity-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
    <div class="card">
        <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1.25rem;">Recent Scan QR Requests</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Points</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for qr in recent_scans %}
                    <tr>
                        <td style="font-size: 0.875rem;">User #{{ qr.redeemed_by }}</td>
                        <td style="font-weight: 700; color: var(--success);">+{{ qr.points }}</td>
                        <td style="font-size: 0.75rem; color: var(--text-muted);">{{ qr.redeemed_at.strftime('%H:%M') }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" style="text-align: center; color: var(--text-muted); padding: 2rem;">No recent
                            scans</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1.25rem;">Recent Redemption Requests</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Reward</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in recent_redemptions %}
                    <tr>
                        <td style="font-size: 0.875rem;">{{ r.user.name }}</td>
                        <td style="font-size: 0.8125rem;">{{ r.reward.name }}</td>
                        <td><span class="badge badge-warning" style="font-size: 0.65rem;">{{ r.status }}</span></td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" style="text-align: center; color: var(--text-muted); padding: 2rem;">No recent
                            redemptions</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Admin Notifications Section -->
{% if notifications %}
<div class="card"
    style="border-left: 4px solid var(--primary); margin-top: 2rem; margin-bottom: 2rem; background: #f5f3ff;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.125rem; font-weight: 700; margin: 0; color: #4338ca;">
            <i class="ph ph-bell-ringing"></i> Live System Alerts
        </h2>
        <span class="badge" style="background: #e0e7ff; color: #4338ca;">{{ notifications|length }} New</span>
    </div>
    <div style="display: grid; gap: 1rem;">
        {% for n in notifications %}
        <div id="notif-{{ n.id }}"
            style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem; border-radius: 12px; border: 1px solid #e0e7ff; box-shadow: 0 2px 4px rgba(67, 56, 202, 0.05);">
            <div style="display: flex; gap: 1rem; align-items: center;">
                <div
                    style="width: 40px; height: 40px; background: #eef2ff; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #4338ca;">
                    {% if 'User' in n.title %}<i class="ph ph-user-plus"></i>
                    {% elif 'QR' in n.title %}<i class="ph ph-qr-code"></i>
                    {% else %}<i class="ph ph-gift"></i>{% endif %}
                </div>
                <div>
                    <div style="font-weight: 700; font-size: 0.9375rem; color: var(--text-main);">{{ n.title }}</div>
                    <div style="font-size: 0.8125rem; color: var(--text-muted);">{{ n.message }}</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span style="font-size: 0.75rem; color: var(--text-muted);">{{ n.created_at.strftime('%H:%M') }}</span>
                <button onclick="markRead({{ n.id }})" class="btn btn-ghost"
                    style="padding: 0.4rem; color: var(--primary);">
                    <i class="ph ph-check-circle" style="font-size: 1.25rem;"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<style>
    .clickable-card {
        text-decoration: none;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .clickable-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
    function markRead(id) {
        fetch(`/admin/notification/${id}/read`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const el = document.getElementById('notif-' + id);
                    el.style.opacity = '0';
                    el.style.transform = 'translateX(20px)';
                    setTimeout(() => {
                        el.remove();
                        // If no more notifications, refresh to hide the whole card
                        if (document.querySelectorAll('[id^="notif-"]').length === 0) {
                            location.reload();
                        }
                    }, 300);
                }
            });
    }
</script>
{% endblock %}